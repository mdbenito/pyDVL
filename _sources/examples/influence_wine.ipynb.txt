{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "a75acfec",
   "metadata": {},
   "source": [
    "# Clean dataset using influence functions and neural networks\n",
    "\n",
    "This notebook shows how to calculate influences on a NN model using pyDVL for an arbitrary dataset.\n",
    "\n",
    "It uses the wine dataset from sklearn: given a set of 13 different input parameters regarding a particular bottle, each related to some physical property (e.g. concentration of magnesium, malic acidity, alcoholic percentage, etc), the model will need to predict to which of 3 classes the wine belongs to. For more details, please refer to the [sklearn documentation](https://scikit-learn.org/stable/datasets/toy_dataset.html#wine-recognition-dataset)."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "68ec440b",
   "metadata": {},
   "source": [
    "Let's start by loading the imports, the dataset and splitting it into train, validation and test sets. We will use a large test set to have a less noisy estimate of the average influence."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "be813151",
   "metadata": {},
   "outputs": [],
   "source": [
    "from valuation.utils.dataset import load_wine_dataset\n",
    "import matplotlib.pyplot as plt\n",
    "import torch\n",
    "from valuation.influence.model_wrappers import TorchNeuralNetwork\n",
    "import torch.nn.functional as F\n",
    "from torch.optim import Adam, lr_scheduler\n",
    "import numpy as np\n",
    "from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay, f1_score\n",
    "\n",
    "train_ds, val_ds, test_ds = load_wine_dataset(train_size=0.3, test_size=0.6)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a018e72c",
   "metadata": {},
   "source": [
    "## Fit a neural network to the data\n",
    "\n",
    "We will train a 2-layer neural network. PyDVL has some convenience wrappers to initialize a pytorch NN. If you already have a model loaded and trained, you can skip this section."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "00dc59af",
   "metadata": {},
   "outputs": [],
   "source": [
    "feature_dimension = train_ds[0].shape[1]\n",
    "unique_classes = np.unique(np.concatenate((train_ds[1], test_ds[1])))\n",
    "num_classes = len(unique_classes)\n",
    "network_size = [16, 16]\n",
    "\n",
    "num_epochs = 300\n",
    "lr = 0.005\n",
    "weight_decay = 0.01\n",
    "device = torch.device(\"cuda:0\" if torch.cuda.is_available() else \"cpu\")\n",
    "\n",
    "nn = TorchNeuralNetwork(feature_dimension, num_classes, network_size)\n",
    "nn.to(device)\n",
    "optimizer = Adam(params=nn.parameters(), lr=lr, weight_decay=weight_decay)\n",
    "scheduler = lr_scheduler.CosineAnnealingLR(optimizer, T_max=num_epochs)\n",
    "\n",
    "train_loss, val_loss = nn.fit(\n",
    "    x_train=train_ds[0],\n",
    "    y_train=train_ds[1],\n",
    "    x_val=val_ds[0],\n",
    "    y_val=val_ds[1],\n",
    "    loss=F.cross_entropy,\n",
    "    optimizer=optimizer,\n",
    "    scheduler=scheduler,\n",
    "    num_epochs=num_epochs,\n",
    "    batch_size=16,\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1a3ba188",
   "metadata": {},
   "source": [
    "Let's check that the training has found a stable minimum by plotting the train and validation loss"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "f4b57b77",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/png": "iVBORw0KGgoAAAANSUhEUgAAAlMAAAGbCAYAAADgEhWsAAAAOXRFWHRTb2Z0d2FyZQBNYXRwbG90bGliIHZlcnNpb24zLjQuMiwgaHR0cHM6Ly9tYXRwbG90bGliLm9yZy8rg+JYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAwaUlEQVR4nO3de5SkdX3n8c+37pe+X4YZpgdnGJDhloCOBIOJRDQZMILxBqjRJCZkPZCoq5wz8WQNetxdc84m2ZDFeHCXeDkqIXhjDQajgkYFZViQ6wADA0wPc+mZvkxfq7qqfvvH81R3dU91d3VVdT/dVe/XOXWq6nmeqvr2QwGf8/396veYc04AAACoTijoAgAAANYzwhQAAEANCFMAAAA1IEwBAADUgDAFAABQg0hQH9zT0+O2bt0a1McDAABU7KGHHjrmnOstty+wMLV161bt2bMnqI8HAAComJm9uNA+hvkAAABqQJgCAACoAWEKAACgBoHNmQIAAOvH9PS0+vv7NTU1FXQpKyqRSKivr0/RaLTi1xCmAADAkvr7+9Xa2qqtW7fKzIIuZ0U453T8+HH19/dr27ZtFb+OYT4AALCkqakpdXd3N2yQkiQzU3d397K7b4QpAABQkUYOUkXV/I2EKQAAgBoQpgAAwJo3PDysz372s8t+3RVXXKHh4eH6F1SCMAUAANa8hcJULpdb9HV33323Ojo6VqgqD7/mAwAAa97u3bv13HPP6YILLlA0GlUikVBnZ6f27t2rZ555Rm9961t14MABTU1N6UMf+pCuu+46SbOXrxsbG9Pll1+u173udfrZz36mzZs369vf/raSyWTNtRGmAADAsnzy/z6hJ18+Udf3POfUNv3VW85dcP9nPvMZPf7443rkkUd033336c1vfrMef/zxmSUMbrvtNnV1dWlyclKvec1r9Pa3v13d3d1z3uPZZ5/V1772NX3+85/Xu971Ln3961/Xe9/73pprJ0wBAIB156KLLpqzFtTNN9+sb37zm5KkAwcO6Nlnnz0pTG3btk0XXHCBJOnVr361XnjhhbrUQpgCAADLslgHabWk0+mZx/fdd5++//3v6/7771cqldKll15adq2oeDw+8zgcDmtycrIutTTsBPSxTE5PHTqhqel80KUAAIAatba2anR0tOy+kZERdXZ2KpVKae/evXrggQdWtbaGDVM/efaYLv/7/9DzA+NBlwIAAGrU3d2tSy65ROedd55uvPHGOft27dqlXC6ns88+W7t379bFF1+8qrU17DBfKhaWJE1kF//JJAAAWB+++tWvlt0ej8f13e9+t+y+4ryonp4ePf744zPbP/axj9WtrobtTKXjxTDFMB8AAFg5DRumUjGv6UZnCgAArKQGDlNeZ2o8Q2cKAACsnAYOU35nil/zAQCAFdSwYWpmzlSGYT4AALByGjZMJSL+MB8T0AEAwApq2DAVCplSsbAmmYAOAEDTaWlpWbXPatgwJXnzpuhMAQCAldSwi3ZK8jtThCkAANa73bt3a8uWLbr++uslSTfddJMikYjuvfdeDQ0NaXp6Wp/+9Kd11VVXrXptDR+mxpmADgBAfX13t3T4sfq+58bzpcs/s+Duq6++Wh/+8IdnwtQdd9yhe+65R3/+53+utrY2HTt2TBdffLGuvPJKmVl9a1tCQ4epdDzCCugAADSACy+8UEePHtXLL7+sgYEBdXZ2auPGjfrIRz6iH//4xwqFQjp48KCOHDmijRs3rmptDR2m6EwBALACFukgraR3vvOduvPOO3X48GFdffXV+spXvqKBgQE99NBDikaj2rp1q6ampla9rgafgB6mMwUAQIO4+uqrdfvtt+vOO+/UO9/5To2MjGjDhg2KRqO699579eKLLwZSV4N3piIaZ2kEAAAawrnnnqvR0VFt3rxZmzZt0nve8x695S1v0fnnn6+dO3dqx44dgdTV4GGKX/MBANBIHntsduJ7T0+P7r///rLHjY2NrVZJjT3Ml45HuNAxAABYUQ0dppLRsCan8yoUXNClAACABtXQYap4sePJabpTAADUyrnGb05U8zc2dJhKRb0/j0noAADUJpFI6Pjx4w0dqJxzOn78uBKJxLJe17gT0J/5nt5x3wd1sz6piUxeag26IAAA1q++vj719/drYGAg6FJWVCKRUF9f37Je07hhqnu7Epljuir8U01krwy6GgAA1rVoNKpt27YFXcaa1LjDfN3bdaL7V/W28E80wTAfAABYIY0bpiQNn/k2nR16STryRNClAACABtXQYWrqlW/VtAur+7lvBF0KAABoUA0dphLtG/Sjwq+ot//fgy4FAAA0qIYOU8lYWM+6PiUnD0kN/FNOAAAQnIYOU+l4WEddh8IuJ00OBV0OAABoQA0dphKRsAbU6T0Z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\n",
      "text/plain": [
       "<Figure size 720x504 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "plt.figure(figsize=(10, 7))\n",
    "plt.plot(train_loss, label=\"train\")\n",
    "plt.plot(val_loss, label=\"val\")\n",
    "plt.legend()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b3345522",
   "metadata": {},
   "source": [
    "Since it is a classification problem, let's also take a look at the confusion matrix on the test set"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "08f1cba4",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay at 0x7fa8b8da6700>"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 2 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "pred_y_test = np.argmax(nn(test_ds[0]).detach(), axis=1)\n",
    "\n",
    "cm = confusion_matrix(test_ds[1], pred_y_test)\n",
    "disp = ConfusionMatrixDisplay(confusion_matrix=cm)\n",
    "disp.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cca76db8",
   "metadata": {},
   "source": [
    "And let's compute the f1 score of the model"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "ca48f9d5",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "0.9720579357550395"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "f1_score(test_ds[1], pred_y_test, average=\"weighted\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5332e2b4",
   "metadata": {},
   "source": [
    "Let's now move to calculating influences of each point on the total score."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "45dbdd1e",
   "metadata": {},
   "source": [
    "## Calculating influences for small neural networks\n",
    "\n",
    "The following cell calculates the influences of each training data-point on the neural network error. \n",
    "The calculation of the Hessian matrix (necessary to calculate the influences) can be quite numerically challenging, but there are some techniques to speed up the calculation. PyDVL allows to use the full method (\"direct\") or the conjugate gradient method (\"cg\"). The first one should be used only for very small networks (like our current example), while for bigger ones \"cg\" is advisable."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "218d0983",
   "metadata": {},
   "outputs": [],
   "source": [
    "from valuation.influence.general import influences\n",
    "\n",
    "inversion_method = \"direct\"  # cg for big networks\n",
    "\n",
    "train_influences = influences(\n",
    "    nn, F.cross_entropy, *train_ds, *test_ds, inversion_method=inversion_method\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ce21c2dc",
   "metadata": {},
   "source": [
    "the returned matrix, train_influences, has a quantity of columns equal to the points in the training set, and a number of rows equal to the points in the test set. At each element $a_{i,j}$ it stores the influence that training point $j$ has on the classification of test point $i$."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4153c7db",
   "metadata": {},
   "source": [
    "If we take the average across every column of the influences matrix, we obtain an estimate of the overall influence of a training point on the total accuracy of the network."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "9169c2dc",
   "metadata": {},
   "outputs": [],
   "source": [
    "mean_train_influences = np.mean(train_influences, axis=0)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b5e254ad",
   "metadata": {},
   "source": [
    "The following histogram shows that there are big differences in score within the training set (notice the log-scale on the y axis)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "233a57da",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Text(0, 0.5, 'number of points')"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 720x504 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "plt.figure(figsize=(10, 7))\n",
    "plt.hist(mean_train_influences, log=True)\n",
    "plt.title(\"Influece scores distribution\")\n",
    "plt.xlabel(\"influece score\")\n",
    "plt.ylabel(\"number of points\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cc27f78c",
   "metadata": {},
   "source": [
    "## Conjugate Gradient and beyond in PyDVL"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9245791c",
   "metadata": {},
   "source": [
    "This was a quick introduction to influence functions and how they could help you in your projects. Give it a try! For example you can try with a bigger neural network and using conjugate gradient for the calculation of influence functions. This can me done in the following way "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "450acac2",
   "metadata": {},
   "outputs": [],
   "source": [
    "train_influences = influences(\n",
    "    nn,\n",
    "    F.cross_entropy,\n",
    "    *train_ds,\n",
    "    *test_ds,\n",
    "    inversion_method=\"cg\",\n",
    "    inversion_method_kwargs={\"max_iterations\": 10, \"max_step_size\": 0.01}\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e802d2d3",
   "metadata": {},
   "source": [
    "where max_iterations and max_step_size and yet another set of hyperparameters that need to be tuned to obtain a good estimate."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4d563f8e",
   "metadata": {},
   "source": [
    "Finally, despite their speed and simplicity, influence functions are known to be a very noisy estimator of data quality, as pointed out in the paper [\"Influence functions in deep learning are fragile\"](https://arxiv.org/abs/2006.14651). The size of the network, the weight decay, the inversion method used for calculating influences, the size of the test set: they all add up to the total amount of noise in the influence values. Experiments may therefore give quantitative and qualitative different results if not averaged across several realisations. Shapley values, on the contrary, have shown to be a more robust, but this comes at the cost of high computational requirements. PyDVL employs several parallelization and caching techniques to optimize such calculations."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.4"
  },
  "vscode": {
   "interpreter": {
    "hash": "4e000971326892723e7f31ded70802f690c31c3620f59a0f99e594aaee3047ef"
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
